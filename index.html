<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Agenda WebApp</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 2em auto; padding: 0 1em; }
        input { width: 70%; padding: 8px; }
        button { padding: 8px 12px; }
        #events { list-style-type: none; padding: 0; }
        #events li { background-color: #f0f0f0; margin: 5px 0; padding: 10px; border-radius: 5px; }
        #status { margin-top: 1em; font-style: italic; color: #555; }
    </style>
</head>
<body>
    <h1>Minha Agenda</h1>

    <h2>Adicionar Novo Evento</h2>
    <div>
        <input type="text" id="event-title" placeholder="Título do novo evento">
        <button onclick="addEvent()">Adicionar Evento</button>
    </div>

    <h2>Próximos Eventos</h2>
    <button onclick="getEvents()">Atualizar Lista</button>
    <ul id="events">
        <!-- Os eventos serão inseridos aqui pelo JavaScript -->
    </ul>
    <div id="status">Carregando...</div>

    <script>
        // --- CONFIGURAÇÃO ---
        // Pega os parâmetros da URL da página
        const urlParams = new URLSearchParams(window.location.search);
        const GAS_URL = urlParams.get('gas_url');
        const API_KEY = urlParams.get('api_key');
        
        const statusDiv = document.getElementById('status');
        const eventsList = document.getElementById('events');
        const eventTitleInput = document.getElementById('event-title');

        // Função genérica para chamar o backend do GAS
        async function callGasApi(action, data = {}) {
            if (!GAS_URL || !API_KEY) {
                statusDiv.textContent = "Erro: 'gas_url' e 'api_key' são parâmetros obrigatórios na URL.";
                return;
            }

            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'cors', // Necessário para requisições cross-origin
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        apiKey: API_KEY,
                        action: action,
                        ...data // Adiciona outros dados, como o título do evento
                    })
                });

                if (!response.ok) {
                    throw new Error(`Erro na requisição: ${response.statusText}`);
                }

                return await response.json();
            } catch (error) {
                statusDiv.textContent = `Erro ao contatar a API: ${error.message}`;
                console.error(error);
            }
        }

        // Função para buscar e exibir os eventos
        async function getEvents() {
            statusDiv.textContent = "Buscando eventos...";
            eventsList.innerHTML = '';
            
            const result = await callGasApi('listEvents');

            if (result && result.events) {
                if(result.events.length === 0) {
                    statusDiv.textContent = "Nenhum evento encontrado nos próximos 30 dias.";
                    return;
                }
                result.events.forEach(event => {
                    const li = document.createElement('li');
                    const startDate = new Date(event.start).toLocaleString('pt-BR');
                    li.textContent = `${event.title} (Início: ${startDate})`;
                    eventsList.appendChild(li);
                });
                statusDiv.textContent = "Eventos carregados.";
            }
        }

        // Função para adicionar um novo evento
        async function addEvent() {
            const title = eventTitleInput.value.trim();
            if (!title) {
                alert("Por favor, digite um título para o evento.");
                return;
            }
            
            statusDiv.textContent = "Adicionando evento...";
            const result = await callGasApi('addEvent', { title: title });

            if (result && result.success) {
                statusDiv.textContent = `Evento "${result.title}" adicionado com sucesso!`;
                eventTitleInput.value = '';
                getEvents(); // Atualiza a lista após adicionar
            } else {
                statusDiv.textContent = `Erro ao adicionar evento: ${result.error || 'Erro desconhecido'}`;
            }
        }

        // Carrega os eventos iniciais quando a página é aberta
        window.onload = getEvents;
    </script>
</body>
</html>